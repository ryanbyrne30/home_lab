apiVersion: v1
kind: ConfigMap
metadata:
  name: clamd-config
  namespace: clamav
data:
  clamd.conf: |
    # specifies the port to run clamd on
    TCPSocket 3310      
    # exposes the port to any incoming requests
    TCPAddr 0.0.0.0     

    #Automatically Generated by clamav-daemon postinst
    #To reconfigure clamd run #dpkg-reconfigure clamav-daemon
    #Please read /usr/share/doc/clamav-daemon/README.Debian.gz for details
    #LocalSocket /var/run/clamav/clamd.sock
    FixStaleSocket true
    LocalSocketGroup clamav
    LocalSocketMode 666
    # TemporaryDirectory is not set to its default /tmp here to make overriding
    # the default with environment variables TMPDIR/TMP/TEMP possible
    User clamav
    ScanMail false
    ScanArchive true
    ArchiveBlockEncrypted false
    MaxDirectoryRecursion 15
    FollowDirectorySymlinks false
    FollowFileSymlinks false
    ReadTimeout 180
    MaxThreads 12
    MaxConnectionQueueLength 15
    LogSyslog false
    LogRotate true
    LogFacility LOG_LOCAL6
    LogClean false
    LogVerbose false
    PreludeEnable no
    PreludeAnalyzerName ClamAV
    DatabaseDirectory /var/lib/clamav
    OfficialDatabaseOnly false
    SelfCheck 3600
    Foreground false
    Debug false
    ScanPE true
    MaxEmbeddedPE 10M
    ScanOLE2 true
    ScanPDF true
    ScanHTML true
    MaxHTMLNormalize 10M
    MaxHTMLNoTags 2M
    MaxScriptNormalize 5M
    MaxZipTypeRcg 1M
    ScanSWF true
    ExitOnOOM false
    LeaveTemporaryFiles false
    AlgorithmicDetection true
    ScanELF true
    IdleTimeout 30
    CrossFilesystems true
    PhishingSignatures true
    PhishingScanURLs true
    PhishingAlwaysBlockSSLMismatch false
    PhishingAlwaysBlockCloak false
    PartitionIntersection false
    DetectPUA false
    ScanPartialMessages false
    HeuristicScanPrecedence false
    StructuredDataDetection false
    CommandReadTimeout 30
    SendBufTimeout 200
    MaxQueue 100
    ExtendedDetectionInfo true
    OLE2BlockMacros false
    AllowAllMatchScan true
    ForceToDisk false
    DisableCertCheck false
    DisableCache false
    MaxScanTime 120000
    MaxScanSize 100M
    MaxFileSize 25M
    MaxRecursion 16
    MaxFiles 10000
    MaxPartitions 50
    MaxIconsPE 100
    PCREMatchLimit 10000
    PCRERecMatchLimit 5000
    PCREMaxFileSize 25M
    ScanXMLDOCS true
    ScanHWP3 true
    MaxRecHWP3 16
    StreamMaxLength 25M
    LogFile /var/log/clamav/clamav.log
    LogTime true
    LogFileUnlock false
    LogFileMaxSize 0
    Bytecode true
    BytecodeSecurity TrustSigned
    BytecodeTimeout 60000
    OnAccessMaxFileSize 5M

  freshclam.conf: |
    DatabaseOwner clamav
    UpdateLogFile /var/log/clamav/freshclam.log
    LogVerbose false
    LogSyslog false
    LogFacility LOG_LOCAL6
    LogFileMaxSize 0
    LogRotate true
    LogTime true
    Foreground false
    Debug false
    MaxAttempts 5
    DatabaseDirectory /var/lib/clamav
    DNSDatabaseInfo current.cvd.clamav.net
    ConnectTimeout 30
    ReceiveTimeout 0
    TestDatabases yes
    ScriptedUpdates yes
    CompressLocalDatabase no
    Bytecode true
    NotifyClamd /etc/clamav/clamd.conf
    # Check for new database 24 times a day
    Checks 24
    DatabaseMirror db.local.clamav.net
    DatabaseMirror database.clamav.net

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: clamd-client-config
  namespace: clamav
data:
  clamd.conf: |
    TCPSocket 3310
    TCPAddr localhost

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: clamd
  namespace: clamav
spec:
  replicas: 1
  selector:
    matchLabels:
      app: clamd
  template:
    metadata:
      labels:
        app: clamd
    spec:
      automountServiceAccountToken: false
      volumes:
        - name: clamd-pvc
          PersistentVolumeReclaimPolicy:
            claimName: clamd-pvc
        - name: clamd-config
          configMap:
            name: clamd-config
        - name: clamd-client-config
          configMap:
            name: clamd-client-config
      containers:
        - name: clamd
          image: clamav/clamav:1.0.4
          ports:
            - containerPort: 3310
          volumeMounts:
            - name: clamd-pvc
              mountPath: /var/lib/clamav
            - name: clamd-config
              mountPath: /etc/clamav
              readOnly: true
          resources:
            limits:
              cpu: 1
              memory: 4Gi
              ephemeral-storage: 8Gi
        - name: scanner-api
          image: rbyrne30/malware-scanner:0.0.4
          ports:
            - containerPort: 9000
          volumeMounts:
            - name: clamd-client-config
              mountPath: /etc/clamav
              readOnly: true
          resources:
            limits:
              cpu: 1
              memory: 1Gi
              ephemeral-storage: 8Gi

---
apiVersion: v1
kind: Service
metadata:
  name: clamd
  namespace: clamav
spec:
  ports:
    - name: clamd
      port: 3310
      targetPort: 3310
    - name: scanner
      port: 9000
      targetPort: 9000
  selector:
    app: clamd
